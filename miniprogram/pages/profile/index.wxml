<view class="container">
  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view wx:if="{{isLoggedIn}}" class="logged-in-view">
    <!-- ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ -->
    <view class="user-header">
      <view class="user-info">
        <button class="avatar-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
          <view class="avatar">
            <image wx:if="{{user.avatar}}" class="avatar-image" src="{{user.avatar}}" mode="aspectFill" />
            <text wx:else class="avatar-text">{{user.name[0]}}</text>
          </view>
        </button>
        <view class="user-details">
          <input 
            class="user-name-input" 
            type="nickname" 
            value="{{user.name}}" 
            placeholder="è¯·è¾“å…¥æ˜µç§°"
            bindblur="onNicknameBlur"
            bindconfirm="onNicknameConfirm"
            maxlength="20"
          />
          <view class="user-meta">
            <text class="user-id">ID: {{user.id}}</text>
            <button class="settings-btn" bindtap="onOpenSettings">
              <text class="settings-icon">âš™ï¸</text>
              <text class="settings-text">è®¾ç½®</text>
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <scroll-view class="content-scroll" scroll-y="true">
      <!-- èœå•åˆ—è¡¨ -->
      <view class="menu-list">
        <view class="menu-item" bindtap="onHistoryOrders">
          <view class="menu-icon">ğŸ“„</view>
          <view class="menu-content">
            <text class="menu-title">å†å²è®¢å•</text>
          </view>
          <view class="menu-meta">
            <text class="menu-status">å³å°†å¼€æ”¾</text>
            <text class="menu-arrow">â†’</text>
          </view>
        </view>

        <view class="menu-item" bindtap="onPlayerCareer">
          <view class="menu-icon">ğŸ†</view>
          <view class="menu-content">
            <text class="menu-title">ç©å®¶ç”Ÿæ¶¯</text>
          </view>
          <view class="menu-meta">
            <text class="menu-status">å³å°†å¼€æ”¾</text>
            <text class="menu-arrow">â†’</text>
          </view>
        </view>
      </view>

      <!-- ç©å®¶è¯„ä»·åŒºåŸŸ -->
      <view wx:if="{{evaluations.length > 0}}" class="evaluations-section">
        <view class="evaluations-header">
          <text class="evaluations-title">ç©å®¶å¯¹æˆ‘çš„è¯„ä»·</text>
          <text class="evaluations-count">å…±{{getTotalEvaluations()}}ä¸ªè¯„ä»·</text>
        </view>

        <view class="evaluations-list">
          <view
            wx:for="{{evaluations}}"
            wx:key="{{item.commentId || item.type}}"
            class="evaluation-item"
          >
            <view class="evaluation-header">
              <text class="evaluation-type">{{item.type}}</text>
              <view class="evaluation-badge">
                <text class="badge-text">{{item.count || item.voters.length}}äººç‚¹èµ</text>
              </view>
            </view>

            <!-- å¦‚æœæœ‰ voters æ•°æ®ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰ï¼Œæ˜¾ç¤ºæŠ•ç¥¨è€…åˆ—è¡¨ -->
            <view wx:if="{{item.voters && item.voters.length > 0}}" class="voters-list">
              <text
                wx:for="{{item.voters}}"
                wx:for-item="voter"
                wx:key="id"
                class="voter-tag"
              >
                {{voter.name}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view wx:else class="not-logged-in-view">
    <!-- èƒŒæ™¯å›¾ç‰‡ -->
    <image class="background-image" src="https://images.unsplash.com/photo-1620023652673-67fdb13dfe2a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxwb2tlciUyMHRhYmxlJTIwY2FyZHMlMjBkYXJrfGVufDF8fHx8MTc2ODgyNzQ4Mnww&ixlib=rb-4.1.0&q=80&w=1080" mode="aspectFill" />
    <view class="background-overlay"></view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="welcome-content">
      <!-- æ ‡é¢˜ -->
      <view class="welcome-title">
        <text>é²¨æ›¼ Shark Mind Club</text>
      </view>

      <!-- åŠŸèƒ½é¢„è§ˆ -->
      <view class="features-preview">
        <view class="feature-item">
          <view class="feature-icon">ğŸ†</view>
          <view class="feature-info">
            <text class="feature-title">å®æ—¶æ’è¡Œæ¦œ</text>
            <text class="feature-subtitle">å±•ç¤ºä½ çš„å®åŠ›ä¸é£æ ¼</text>
          </view>
        </view>

        <view class="feature-item">
          <view class="feature-icon">ğŸ‘¥</view>
          <view class="feature-info">
            <text class="feature-title">ç©å®¶é£æ ¼è¯„ä»·</text>
            <text class="feature-subtitle">äº†è§£ç‰Œæ¡Œä¸Šçš„å¯¹æ‰‹</text>
          </view>
        </view>

        <view class="feature-item">
          <view class="feature-icon">ğŸ“„</view>
          <view class="feature-info">
            <text class="feature-title">åœ¨çº¿ç‚¹é¤</text>
            <text class="feature-subtitle">ä¸“æ³¨æ¸¸æˆï¼Œç¾é£Ÿé€è¾¾</text>
          </view>
        </view>
      </view>

      <!-- ç™»å½•æŒ‰é’® -->
      <button class="login-btn" bindtap="onLoginClick">
        <text class="login-text">ç™»å½•</text>
        <text class="login-icon">ğŸ”‘</text>
      </button>
    </view>
  </view>

  <!-- è¯„ä»·è®¾ç½®æ¨¡æ€æ¡† -->
  <view wx:if="{{showSettingsModal}}" class="modal-overlay" bindtap="onCloseSettingsModal">
    <view class="modal-content settings-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">è¯„ä»·è®¾ç½®</text>
        <text class="modal-close" bindtap="onCloseSettingsModal">âœ•</text>
      </view>
      <view class="modal-body">
        <text class="settings-message">è®¾ç½®æ˜¯å¦å…è®¸å…¶ä»–ç©å®¶å¯¹ä½ è¿›è¡Œè¯„ä»·</text>

        <view class="setting-item">
          <text class="setting-label">å…è®¸è¯„ä»·</text>
          <switch
            checked="{{user.commentsSwitch !== undefined ? user.commentsSwitch : user.allowEvaluation}}"
            catchchange="onToggleEvaluationSwitch"
            disabled="{{!canToggleEvaluation()}}"
            data-value="{{!(user.commentsSwitch !== undefined ? user.commentsSwitch : user.allowEvaluation)}}"
          />
        </view>

        <view wx:if="{{!canToggleEvaluation()}}" class="cooldown-notice">
          <text>è®¾ç½®è¿‡äºé¢‘ç¹ï¼Œè¯·24å°æ—¶åå†è¯•</text>
        </view>

        <view class="setting-status">
          <text>å½“å‰çŠ¶æ€ï¼š{{(user.commentsSwitch !== undefined ? user.commentsSwitch : user.allowEvaluation) ? 'å·²å¼€å¯' : 'å·²å…³é—­'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>